import React, { useEffect } from 'react'
import { useQuery } from 'react-apollo'
import { applyModifiers, useCssHandles } from 'vtex.css-handles'
import { usePixel } from 'vtex.pixel-manager'
import { useProduct } from 'vtex.product-context'
import type { ProductContextState } from 'vtex.product-context/react/ProductContextProvider'

import RATING from './graphql/getShippingBar.gql'

const CSS_HANDLES = ['productInfo', 'productInfoAvailable', 'stars'] as const

const EmptyStar = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="15"
    height="15"
    viewBox="0 0 15 15"
    fill="none"
    className="vtex-icon"
  >
    <path
      d="M14.0103 6.13427C13.9103 6.25427 13.8104 6.38133 13.7034 6.49133C12.7501 7.42466 11.7939 8.35792 10.8352 9.29125C10.8045 9.31687 10.7816 9.35066 10.7691 9.38867C10.7565 9.42667 10.7547 9.46745 10.7642 9.50634C11.0062 10.8963 11.2459 12.2866 11.4832 13.6772C11.502 13.7556 11.4968 13.8379 11.4681 13.9132C11.4393 13.9885 11.3885 14.0534 11.3223 14.0994C11.2535 14.1493 11.171 14.177 11.086 14.179C11.001 14.1809 10.9173 14.157 10.8462 14.1103C10.1536 13.745 9.46071 13.3807 8.76737 13.0173C8.21937 12.7293 7.66728 12.4433 7.12528 12.1503C7.08986 12.1278 7.04885 12.1158 7.00688 12.1158C6.96491 12.1158 6.92365 12.1278 6.88822 12.1503C5.66889 12.7943 4.44867 13.4363 3.22733 14.0763C3.15709 14.118 3.0808 14.1487 3.00126 14.1674C2.93571 14.1781 2.86844 14.1726 2.80546 14.1515C2.74248 14.1304 2.68576 14.0942 2.63993 14.0461C2.59411 13.998 2.56057 13.9395 2.54252 13.8756C2.52447 13.8117 2.52227 13.7443 2.53617 13.6793C2.65217 12.9883 2.77118 12.2973 2.89018 11.6063C3.01218 10.8973 3.13329 10.1893 3.26029 9.48132C3.26733 9.44373 3.26342 9.40483 3.24906 9.36938C3.23471 9.33393 3.21045 9.30335 3.17924 9.28125C2.19924 8.32791 1.22023 7.37366 0.242227 6.41833C0.206227 6.38333 0.169294 6.34925 0.135294 6.31225C0.0786592 6.25846 0.0390504 6.18933 0.02128 6.11328C0.00350967 6.03722 0.00825768 5.95759 0.035196 5.88427C0.0599543 5.81007 0.106023 5.74475 0.16752 5.69641C0.229018 5.64806 0.303436 5.61884 0.381387 5.6123L2.81425 5.25732C3.40425 5.17132 3.99424 5.08431 4.58524 5.00231C4.62276 4.99914 4.65869 4.98541 4.68876 4.96276C4.71883 4.94012 4.74199 4.90943 4.75541 4.87426C5.36941 3.62426 5.98469 2.37531 6.60136 1.12731C6.62765 1.05667 6.6702 0.99322 6.72563 0.942134C6.78106 0.891047 6.84765 0.853694 6.92021 0.833247C7.01726 0.812689 7.11851 0.827503 7.20561 0.874995C7.29271 0.922487 7.36002 0.999563 7.3953 1.09228C7.5953 1.49228 7.7954 1.89934 7.9954 2.30334C8.41873 3.16001 8.84122 4.01724 9.26322 4.87524C9.27679 4.91022 9.30006 4.94079 9.33012 4.96325C9.36018 4.98571 9.39599 4.99923 9.43339 5.00231C10.4614 5.14898 11.4885 5.29769 12.5152 5.44836C12.8532 5.49736 13.1903 5.54828 13.5293 5.59228C13.6315 5.59543 13.7308 5.62737 13.8157 5.68432C13.9006 5.74127 13.9676 5.82095 14.0093 5.9143L14.0103 6.13427Z"
      fill="#E3E3E3"
    />
  </svg>
)

const FulStar = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="15"
    viewBox="0 0 14 15"
    fill="none"
    className="vtex-icon"
  >
    <path
      d="M14.0093 6.13427C13.9093 6.25427 13.8094 6.38133 13.7024 6.49133C12.7491 7.42466 11.7929 8.35792 10.8343 9.29125C10.8035 9.31687 10.7807 9.35066 10.7681 9.38867C10.7556 9.42667 10.7538 9.46745 10.7632 9.50634C11.0052 10.8963 11.2449 12.2866 11.4822 13.6772C11.501 13.7556 11.4958 13.8379 11.4671 13.9132C11.4384 13.9885 11.3876 14.0534 11.3213 14.0994C11.2525 14.1493 11.17 14.177 11.085 14.179C11 14.1809 10.9163 14.157 10.8453 14.1103C10.1526 13.745 9.45973 13.3807 8.7664 13.0173C8.2184 12.7293 7.66631 12.4433 7.12431 12.1503C7.08888 12.1278 7.04787 12.1158 7.0059 12.1158C6.96393 12.1158 6.92267 12.1278 6.88725 12.1503C5.66791 12.7943 4.44769 13.4363 3.22636 14.0763C3.15611 14.118 3.07982 14.1487 3.00028 14.1674C2.93473 14.1781 2.86747 14.1726 2.80448 14.1515C2.7415 14.1304 2.68478 14.0942 2.63896 14.0461C2.59313 13.998 2.5596 13.9395 2.54154 13.8756C2.52349 13.8117 2.52129 13.7443 2.5352 13.6793C2.6512 12.9883 2.7702 12.2973 2.8892 11.6063C3.0112 10.8973 3.13232 10.1893 3.25932 9.48132C3.26635 9.44373 3.26244 9.40483 3.24809 9.36938C3.23373 9.33393 3.20947 9.30335 3.17826 9.28125C2.19826 8.32791 1.21925 7.37366 0.241251 6.41833C0.205251 6.38333 0.168317 6.34925 0.134317 6.31225C0.0776826 6.25846 0.0380738 6.18933 0.0203035 6.11328C0.00253311 6.03722 0.00728112 5.95759 0.0342195 5.88427C0.0589777 5.81007 0.105046 5.74475 0.166544 5.69641C0.228041 5.64806 0.30246 5.61884 0.380411 5.6123L2.81327 5.25732C3.40327 5.17132 3.99327 5.08431 4.58427 5.00231C4.62178 4.99914 4.65771 4.98541 4.68778 4.96276C4.71786 4.94012 4.74102 4.90943 4.75443 4.87426C5.36843 3.62426 5.98371 2.37531 6.60038 1.12731C6.62667 1.05667 6.66922 0.99322 6.72465 0.942134C6.78008 0.891047 6.84667 0.853694 6.91923 0.833247C7.01628 0.812689 7.11753 0.827503 7.20463 0.874995C7.29173 0.922487 7.35904 0.999563 7.39433 1.09228C7.59433 1.49228 7.79442 1.89934 7.99442 2.30334C8.41776 3.16001 8.84025 4.01724 9.26225 4.87524C9.27582 4.91022 9.29908 4.94079 9.32914 4.96325C9.3592 4.98571 9.39502 4.99923 9.43241 5.00231C10.4604 5.14898 11.4875 5.29769 12.5142 5.44836C12.8522 5.49736 13.1894 5.54828 13.5284 5.59228C13.6305 5.59543 13.7298 5.62737 13.8147 5.68432C13.8996 5.74127 13.9667 5.82095 14.0083 5.9143L14.0093 6.13427Z"
      fill="#FCD200"
    />
  </svg>
)

export default function CustomProductInfo({
  children,
}: {
  children?: React.ReactNode
}) {
  const { handles } = useCssHandles(CSS_HANDLES)
  const { product, buyButton } = useProduct() as ProductContextState

  const { push } = usePixel()

  useEffect(() => {
    // abire o minicart quando o botão de compra é clicado
    if (buyButton?.clicked) {
      push({
        event: 'add-to-cart-button' as any,
        id: 'add-to-cart-button',
      })
      buyButton.clicked = false
    }
  }, [buyButton, push])

  const { data, loading } = useQuery<{
    averageRatingByProductId: {
      average: number
      starsFive: number
      starsFour: number
      starsThree: number
      starsTwo: number
      starsOne: number
      total: number
    }
  }>(RATING, {
    variables: {
      productId: product?.productId,
    },
    ssr: false,
    skip: !product?.productId,
  })

  const rating = data?.averageRatingByProductId?.average ?? 0

  const intRating = Math.round(rating)
  const stars = Array.from({ length: 5 }, (_, i) => (i < intRating ? 1 : 0))

  return (
    <section className={handles.productInfo}>
      <p className={handles.productInfoAvailable}>Disponível: Loja 01</p>
      <p className={handles.productInfoAvailable}>
        ref: {product?.productReference}
      </p>
      <div className={applyModifiers(handles.stars, loading ? 'loading' : '')}>
        {stars.map((star, index) =>
          star === 1 ? <FulStar key={index} /> : <EmptyStar key={index} />
        )}
      </div>
      {children}
    </section>
  )
}
